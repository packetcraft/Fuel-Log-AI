<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Fuel Log AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap");

        :root {
            font-size: 16px;
            --primary-blue: #007bff;
            --light-gray: #f8f9fa;
            --white: #ffffff;
            --dark-gray: #343a40;
            --text-muted: #6c757d;
        }

        body {
            font-family: "Inter", sans-serif;
            background: var(--light-gray);
            color: var(--dark-gray);
            overflow: hidden;
            height: 100svh;
            display: flex;
            flex-direction: column;
        }

        .card {
            background: var(--white);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        input,
        select {
            background: #fff !important;
            border: 1px solid #ced4da !important;
            color: var(--dark-gray) !important;
            padding: 12px !important;
            width: 100%;
            border-radius: 8px;
            font-size: 16px !important;
        }

        label {
            font-size: 12px !important;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: block;
            text-transform: uppercase;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 700;
            border-radius: 8px;
            padding: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background-color 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: var(--primary-blue);
            font-weight: 700;
            border-radius: 8px;
        }

        #loadingOverlay,
        #missionReport {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }

        #missionReport {
            background: var(--white);
            color: var(--dark-gray);
            border-radius: 16px;
            max-width: 320px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .grade-badge {
            font-size: 5rem;
            font-weight: 900;
            line-height: 1;
            margin: 1rem 0;
            color: var(--primary-blue);
        }

        .tab-panel {
            display: none;
            height: calc(100svh - 160px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .tab-panel.active {
            display: block;
        }

        .nav-active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-blue);
        }

        table {
            width: 100%;
            font-size: 0.85rem;
        }

        th {
            color: var(--primary-blue);
            border-bottom: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }
    </style>
</head>

<body class="max-w-md mx-auto p-4 flex flex-col">
    <div id="loadingOverlay">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loadText" class="text-xs text-white tracking-widest uppercase">
            Loading...
        </p>
    </div>

    <div id="missionReport" style="display: none;" onclick="this.style.display='none'">
        <p class="text-blue-500 font-bold tracking-widest uppercase text-xs mb-2">Refill Complete</p>
        <h2 class="text-3xl font-black tracking-tighter text-gray-800">Log Confirmed</h2>
        <div id="grade" class="grade-badge">A</div>
        <div class="grid grid-cols-2 gap-4 text-center my-4 w-full">
            <div>
                <p class="text-xs text-slate-500 uppercase font-bold">Efficiency</p>
                <p id="effVal" class="text-2xl font-black text-gray-800">-- <span class="text-xs">KM/L</span></p>
            </div>
            <div>
                <p class="text-xs text-slate-500 uppercase font-bold">Trend</p>
                <p id="effTrend" class="text-2xl font-black text-blue-500">STABLE</p>
            </div>
        </div>
        <p class="text-slate-400 font-mono text-xs mt-6 uppercase">Tap to close</p>
    </div>

    <header class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-black text-blue-600 tracking-tighter">
            Fuel Log AI
        </h1>
        <div class="flex gap-2">
            <button onclick="openScanner(true)"
                class="px-3 py-2 btn-secondary text-sm">
                üì∑ Cam
            </button>
            <button onclick="openScanner(false)"
                class="px-3 py-2 btn-secondary text-sm">
                üìÅ File
            </button>
        </div>
        <input type="file" id="cam" accept="image/*" class="hidden" onchange="processImage(event)" />
    </header>

    <main class="flex-1 overflow-hidden">
        <div id="tab0" class="tab-panel active">
            <form id="f" onsubmit="sub(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label>Vehicle</label>
                        <select name="vehicle_name" id="vehicleSelect" class="h-12 font-bold"></select>
                    </div>
                    <div>
                        <label>Fuel Type</label>
                        <select name="fuel_type" id="fuelType" class="h-12 font-bold">
                            <option value="petrol">Petrol</option>
                            <option value="diesel">Diesel</option>
                            <option value="cng">CNG</option>
                        </select>
                    </div>
                </div>
                 <button type="button" onclick="addVehicle()"
                    class="w-full h-10 btn-secondary text-xs">
                    + Add New Vehicle
                </button>

                <div class="grid grid-cols-2 gap-3 items-center">
                    <div class="card p-3">
                        <label>Odometer (KM)</label>
                        <input type="number" name="km_reading" id="k" step="0.1" required class="mt-1" />
                    </div>
                    <div class="card p-3 h-full flex flex-col justify-center items-center gap-1">
                        <label>Status</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="full_tank" id="ft" class="w-5 h-5 accent-blue-500" checked />
                            <span class="text-sm font-bold">Full Tank</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-3">
                        <label>Quantity (L)</label>
                        <input type="number" name="fuel_qty" id="q" step="0.01" required oninput="calc()"
                            class="mt-1" />
                    </div>
                    <div class="card p-3">
                        <label>Price / L</label>
                        <input type="number" name="fuel_price" id="p" step="0.01" required oninput="calc()"
                            class="mt-1" />
                    </div>
                </div>

                <div class="card p-4 flex justify-between items-center bg-blue-50 border-2 border-blue-200">
                    <div>
                        <p class="text-xs font-bold text-blue-600 uppercase">
                            Total Cost
                        </p>
                        <input type="number" name="refill_amount" id="t"
                            class="!bg-transparent !border-none !p-0 text-3xl font-black text-blue-600" readonly />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" name="refill_date" id="d" required class="font-bold" />
                    <div class="flex items-center">
                        <input type="text" name="pump_location" id="l" placeholder="Station Name" class="font-bold rounded-r-none" />
                        <button type="button" onclick="fetchGPS()"
                            class="bg-blue-500 text-white h-12 w-12 rounded-l-none rounded-r-lg shadow-lg flex items-center justify-center text-2xl flex-shrink-0">
                            üìç
                        </button>
                    </div>
                </div>

                <button type="submit" id="s"
                    class="w-full py-5 btn-primary text-xl">
                    Save Log
                </button>
            </form>
        </div>

        <div id="tab1" class="tab-panel">
            <div class="card overflow-hidden">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Full</th>
                            <th>Liters</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab2" class="tab-panel space-y-4">
            <div id="statsGrid" class="grid gap-3"></div>
            <div class="p-3 card">
                <canvas id="effChart"></canvas>
            </div>
        </div>

        <div id="tab3" class="tab-panel space-y-4">
            <div class="text-center card p-4">
                <p id="mCity" class="text-sm font-bold text-blue-600 uppercase tracking-widest">
                    Loading...
                </p>
                <div id="mInsight" class="text-lg font-bold mt-2 text-gray-800"></div>
            </div>
            <div id="mMarket" class="grid grid-cols-2 gap-3 text-center"></div>
            <div id="mSources" class="space-y-2"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 grid grid-cols-4 h-16 shadow-inner">
        <button onclick="setTab(0)" class="nav-btn flex items-center justify-center nav-active font-bold text-sm">
            Add
        </button>
        <button onclick="setTab(1)" class="nav-btn flex items-center justify-center text-gray-500 font-bold text-sm">
            Logs
        </button>
        <button onclick="setTab(2)" class="nav-btn flex items-center justify-center text-gray-500 font-bold text-sm">
            Stats
        </button>
        <button onclick="setTab(3)" class="nav-btn flex items-center justify-center text-gray-500 font-bold text-sm">
            Market
        </button>
    </nav>

     <script>
        let logs = [];
        let chart = null;
        let vehicleList = [];
        let lastUserPrice = 0;
        const colors = ["#007bff", "#6f42c1", "#28a745", "#dc3545", "#fd7e14"];

        function showLoading(t) {
            document.getElementById("loadText").textContent = t;
            document.getElementById("loadingOverlay").style.display = "flex";
        }
        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        function handleError(err) {
            hideLoading();
            const msg = err.message || "An error occurred. Please try again.";
            alert("Error: " + msg);
            console.error(err);
        }

        window.onload = () => {
            document.getElementById("d").value = new Date().toISOString().split("T")[0];
            ref();
        };

        function addVehicle() {
            const n = prompt("Enter a name for the new vehicle:");
            if (n && n.trim()) {
                const s = document.getElementById("vehicleSelect");
                s.add(new Option(n.trim(), n.trim()));
                s.value = n.trim();
            }
        }

        function setTab(idx) {
            document.querySelectorAll(".tab-panel").forEach((p, i) => p.classList.toggle("active", i === idx));
            document.querySelectorAll(".nav-btn").forEach((b, i) => {
                b.classList.toggle("nav-active", i === idx);
                b.classList.toggle("text-gray-500", i !== idx);
            });
            if (idx === 1) rend();
            if (idx === 2) stats();
            if (idx === 3) loadMarket();
        }

        function ref() {
            showLoading("Syncing data...");
            google.script.run
                .withSuccessHandler((res) => {
                    hideLoading();
                    if (res.success) {
                        logs = res.data;
                        vehicleList = res.vehicles;
                        lastUserPrice = res.lastPrice;
                        const s = document.getElementById("vehicleSelect");
                        s.innerHTML = '';
                        if (res.vehicles.length > 0) {
                             res.vehicles.forEach((v) => s.add(new Option(v, v)));
                        } else {
                            s.add(new Option("My Car", "My Car"));
                        }
                    } else {
                        alert("Database Sync Failed.");
                    }
                })
                .withFailureHandler(handleError)
                .getDataProtocol();
        }

        function calc() {
            const q = parseFloat(document.getElementById("q").value) || 0;
            const p = parseFloat(document.getElementById("p").value) || 0;
            document.getElementById("t").value = (q * p).toFixed(2);
        }

        function sub(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            data.full_tank = document.getElementById("ft").checked;
            showLoading("Saving entry...");
            google.script.run
                .withSuccessHandler(() => {
                    hideLoading();
                    showMissionReport(data);
                    e.target.reset();
                    document.getElementById("d").value = new Date().toISOString().split("T")[0];
                    setTimeout(ref, 3000);
                })
                .withFailureHandler(handleError)
                .saveEntryDirect(data);
        }

        function showMissionReport(currentEntry) {
            const el = document.getElementById("missionReport");
            if (!el) return;

            document.getElementById("effVal").innerHTML = `-- <span class="text-xs">KM/L</span>`;
            document.getElementById("effTrend").textContent = "STABLE";
            document.getElementById("effTrend").className = "text-2xl font-black text-blue-500";
            document.getElementById("grade").textContent = "B";

            try {
                const vName = currentEntry.vehicle_name;
                const vLogs = logs.filter(l => l.vehicle_name === vName);

                if (vLogs.length > 0) {
                    const last = vLogs[0];
                    const dist = parseFloat(currentEntry.km_reading) - parseFloat(last.km_reading);
                    const fuel = parseFloat(currentEntry.fuel_qty);

                    if (dist > 0 && fuel > 0) {
                        const eff = (dist / fuel).toFixed(1);
                        document.getElementById("effVal").innerHTML = `${eff} <span class="text-xs">KM/L</span>`;

                        let grade = "C";
                        if (eff > 15) grade = "B";
                        if (eff > 18) grade = "A";
                        if (eff > 22) grade = "S";
                        document.getElementById("grade").textContent = grade;

                        if (logs.length > 1) {
                            const prevDist = logs[0].km_reading - logs[1].km_reading;
                            const prevFuel = logs[0].fuel_qty;
                            const prevEff = prevDist / prevFuel;
                            if (prevEff > 0) {
                                const diff = ((eff - prevEff) / prevEff * 100).toFixed(1);
                                document.getElementById("effTrend").textContent = (diff > 0 ? "+" : "") + diff + "%";
                                document.getElementById("effTrend").className = diff >= 0 ? "text-2xl font-black text-green-500" : "text-2xl font-black text-red-500";
                            }
                        }
                    }
                }
            } catch (err) {
                console.warn("HUD Calculation Error:", err);
            }

            el.style.display = 'flex';
            setTimeout(() => { el.style.display = "none"; }, 6000);
        }

        function rend() {
            const b = document.getElementById("logTable");
             if (logs.length === 0) {
                b.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">No logs yet. Add your first entry!</td></tr>`;
                return;
            }
            b.innerHTML = "";
            logs.slice(0, 15).forEach((e) => {
                b.innerHTML += `<tr><td>${e.refill_date.split("T")[0].slice(5)}</td><td class="font-bold uppercase text-sm">${e.vehicle_name}</td><td>${e.full_tank == true || e.full_tank == "true" ? "‚úì" : "‚Äî"}</td><td>${parseFloat(e.fuel_qty).toFixed(1)}</td><td class="text-blue-600 font-bold">‚Çπ${parseFloat(e.refill_amount).toFixed(0)}</td></tr>`;
            });
        }

        function stats() {
            const container = document.getElementById("statsGrid");
            container.innerHTML = "";
            const datasets = [];
            vehicleList.forEach((vName, idx) => {
                const vLogs = logs.filter((e) => e.vehicle_name === vName).reverse();
                if (vLogs.length < 2) return;

                const fuel = vLogs.reduce((s, e) => s + (parseFloat(e.fuel_qty) || 0), 0);
                const odos = vLogs.map((e) => parseFloat(e.km_reading) || 0);
                const dist = Math.max(...odos) - Math.min(...odos);
                const eff = dist > 0 ? (dist / fuel).toFixed(2) : "0.0";
                const color = colors[idx % colors.length];

                container.innerHTML += `
                    <div class="card p-4 flex justify-between items-center border-l-4" style="border-left-color: ${color}">
                        <span class="text-sm font-black uppercase text-slate-600">${vName}</span>
                        <span class="text-2xl font-black" style="color: ${color}">${eff} <span class="text-xs">KM/L</span></span>
                    </div>`;

                const chartData = [];
                for (let i = 1; i < vLogs.length; i++) {
                    const d = vLogs[i].km_reading - vLogs[i - 1].km_reading;
                    const f = vLogs[i].fuel_qty;
                    if (d > 0 && f > 0 && (vLogs[i].full_tank == true || vLogs[i].full_tank == "true")) {
                        chartData.push({
                            x: vLogs[i].refill_date.split("T")[0].slice(5),
                            y: (d / f).toFixed(2),
                        });
                    }
                }
                datasets.push({
                    label: vName,
                    data: chartData,
                    borderColor: color,
                    backgroundColor: color + "22",
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                });
            });

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById("effChart"), {
                type: "line",
                data: { datasets: datasets },
                options: {
                    scales: {
                        y: { grid: { color: "#e9ecef" }, ticks: { color: "#6c757d", font: { size: 10 } } },
                        x: { type: "category", grid: { display: false }, ticks: { color: "#6c757d", font: { size: 10 } } },
                    },
                    plugins: { legend: { labels: { color: "#343a40", font: { size: 12, weight: "bold" } } } },
                },
            });
        }

        function loadMarket() {
            showLoading("Checking market...");
            navigator.geolocation.getCurrentPosition((p) => {
                google.script.run
                    .withSuccessHandler((res) => {
                        hideLoading();
                        if (!res || !res.success) return;
                        const m = res.market;
                        document.getElementById("mCity").textContent = "Region: " + m.city.toUpperCase();
                        document.getElementById("mInsight").textContent = m.insight;
                        document.getElementById("mMarket").innerHTML = `
                        <div class="card p-4"><p class="text-sm text-blue-600 font-bold uppercase">Petrol</p><p class="text-3xl font-black">‚Çπ${m.petrol}</p></div>
                        <div class="card p-4"><p class="text-sm text-red-600 font-bold uppercase">Diesel</p><p class="text-3xl font-black">‚Çπ${m.diesel}</p></div>`;
                        document.getElementById("mSources").innerHTML = m.sources.map((s) =>
                            `<a href="${s.url}" target="_blank" class="block p-3 card text-xs text-blue-600 font-bold border-dashed uppercase">Source: ${s.title} ‚Üó</a>`
                        ).join("");
                    })
                    .withFailureHandler(handleError)
                    .getMarketData(p.coords.latitude, p.coords.longitude, lastUserPrice);
            }, (err) => {
                hideLoading();
                alert("Location Access Denied. Live Market unavailable.");
            }, { enableHighAccuracy: true, timeout: 5000 });
        }

        function fetchGPS() {
            navigator.geolocation.getCurrentPosition((p) => {
                document.getElementById("l").value = `${p.coords.latitude.toFixed(3)},${p.coords.longitude.toFixed(3)}`;
            }, (err) => {
                alert("GPS Signal Blocked.");
            }, { enableHighAccuracy: true, timeout: 5000 });
        }

        function openScanner(forceCam) {
            const input = document.getElementById('cam');
            if (forceCam) {
                input.setAttribute('capture', 'environment');
            } else {
                input.removeAttribute('capture');
            }
            input.click();
        }

        function processImage(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const i = new Image();
                i.onload = () => {
                    const c = document.createElement("canvas");
                    let w = i.width, h = i.height;
                    const max_size = 800;
                    if (w > max_size || h > max_size) {
                        if (w > h) {
                            h *= max_size / w;
                            w = max_size;
                        } else {
                            w *= max_size / h;
                            h = max_size;
                        }
                    }
                    c.width = w;
                    c.height = h;
                    c.getContext("2d").drawImage(i, 0, 0, w, h);
                    showLoading("Processing receipt...");
                    google.script.run
                        .withSuccessHandler((res) => {
                            hideLoading();
                            if (res && res.success) {
                                const fieldMap = {
                                    'fuel_qty': 'q',
                                    'fuel_price': 'p',
                                    'pump_location': 'l'
                                };
                                Object.keys(fieldMap).forEach(key => {
                                   const elId = fieldMap[key];
                                   const el = document.getElementById(elId);
                                   if(res.data[key] && el) {
                                        el.value = res.data[key];
                                        el.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');
                                        setTimeout(() => el.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200'), 3000);
                                   }
                                });
                                calc();
                            } else {
                                alert("AI could not read the receipt. Please enter manually.")
                            }
                        })
                        .withFailureHandler(handleError)
                        .processReceiptWithAI(c.toDataURL("image/jpeg", 0.7).split(",")[1]);
                };
                i.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }
    </script>
</body>
</html>