<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Fuel Log AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@800&display=swap");

        :root {
            font-size: 16px;
            --primary-yellow: #FFDE03;
            --black: #1A1A1A;
            --white: #ffffff;
            --background: #F4F4F4;
            --accent-red: #FF4646;
            --card-bg: var(--white);
            --text-color: var(--black);
            --border-color: var(--black);
            --shadow-color: var(--black);
            --input-bg: var(--white);
        }

        [data-theme="dark"] {
            --primary-yellow: #fde047;
            --black: #000000;
            --white: #1e1e1e;
            --background: #121212;
            --accent-red: #ff5252;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --shadow-color: #000000;
            --input-bg: #2a2a2a;
        }

        body {
            font-family: "Inter", sans-serif;
            font-weight: 800;
            background: var(--background);
            color: var(--text-color);
            overflow: hidden;
            height: 100svh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background: var(--card-bg);
            border: 3px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 4px 4px 0px var(--shadow-color);
        }

        input,
        select,
        textarea {
            background: var(--input-bg) !important;
            border: 3px solid var(--border-color) !important;
            color: var(--text-color) !important;
            padding: 12px !important;
            width: 100%;
            border-radius: 8px;
            font-size: 16px !important;
            font-weight: 800;
            box-shadow: 2px 2px 0px var(--shadow-color);
            transition: all 0.2s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            background-color: var(--input-bg) !important;
            border-color: var(--primary-yellow) !important;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--shadow-color);
        }

        /* FORCE DROPDOWN ARROW VISIBILITY */
        input::-webkit-calendar-picker-indicator {
            opacity: 1 !important;
            display: block !important;
            background-color: transparent;
            cursor: pointer;
            margin-left: 5px;
            filter: invert(var(--invert-icon));
            transition: transform 0.2s;
        }
        
        input:focus::-webkit-calendar-picker-indicator {
            transform: rotate(180deg);
        }

        [data-theme="dark"] {
            --invert-icon: 1;
        }
        [data-theme="light"] {
            --invert-icon: 0;
        }

        label {
            font-size: 0.8rem !important;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 4px;
            display: block;
            opacity: 0.9;
        }

        .btn {
            background-color: var(--primary-yellow);
            color: var(--black);
            border: 3px solid var(--border-color);
            border-radius: 8px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 4px 4px 0px var(--shadow-color);
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            cursor: pointer;
        }

        .btn:active {
            transform: scale(0.95) translate(2px, 2px);
            box-shadow: 0px 0px 0px var(--shadow-color);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        #total_cost_card {
            background-color: var(--primary-yellow);
            box-shadow: 6px 6px 0px var(--shadow-color);
            pointer-events: none;
            color: var(--black);
        }

        /* Specific Vehicle Colors */
        .btn-kylaq {
            background-color: #22c55e !important; /* Green */
            color: white !important;
            border-color: #14532d !important;
        }
        
        .btn-octavia {
            background-color: #ef4444 !important; /* Red */
            color: white !important;
            border-color: #7f1d1d !important;
        }

        /* Toast System */
        #toastContainer {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            width: 100%;
            max-width: 320px;
        }

        .toast {
            background: var(--primary-yellow);
            color: var(--black);
            border: 3px solid var(--black);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 800;
            box-shadow: 4px 4px 0px var(--black);
            text-transform: uppercase;
            font-size: 0.8rem;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.3s forwards 2.7s;
            pointer-events: auto;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                transform: translateY(-20px);
                opacity: 0;
            }
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }

        #missionReport {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }

        .mission-card {
            background: var(--primary-yellow);
            color: var(--black);
            border: 3px solid var(--black);
            border-radius: 12px;
            max-width: 340px;
            padding: 2rem;
            text-align: center;
            box-shadow: 8px 8px 0px var(--black);
        }


        .grade-badge {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            margin: 1rem 0;
            color: var(--black);
        }

        .tab-panel {
            display: none;
            height: calc(100svh - 160px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .tab-panel.active {
            display: block;
        }

        .nav-active {
            background: var(--primary-yellow);
            box-shadow: inset 4px 4px 0px #00000033;
        }

        table {
            width: 100%;
            font-size: 0.85rem;
        }

        th {
            color: var(--text-color);
            background: var(--card-bg);
            border-bottom: 3px solid var(--border-color);
            padding: 10px;
            text-align: left;
            font-weight: 800;
            text-transform: uppercase;
        }

        td {
            padding: 12px 10px;
            border-bottom: 3px solid var(--border-color);
        }

        .nav-btn {
            transition: background-color 0.2s ease;
        }

        .nav-btn:active {
            background: var(--primary-yellow);
            opacity: 0.8;
        }

        .log-card {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 3px solid var(--border-color);
            background: var(--card-bg);
            transition: background-color 0.2s;
        }

        .log-card:last-child {
            border-bottom: none;
        }

        .log-card:active {
            background-color: var(--background);
        }

        .log-date {
            font-size: 0.7rem;
            font-weight: 800;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        .log-vehicle {
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
        }

        .log-cost {
            font-size: 1.25rem;
            font-weight: 900;
            text-align: right;
        }

        .log-details {
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 4px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        /* Tab Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Smart Vehicle Selector */
        .vehicle-radio-group {
            display: none;
            gap: 0.5rem;
        }

        .vehicle-radio {
            flex: 1;
            padding: 1rem;
            background: var(--card-bg);
            border: 3px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .vehicle-radio.selected {
            background: var(--primary-yellow);
            color: var(--black);
            opacity: 1;
            box-shadow: 4px 4px 0px var(--shadow-color);
            transform: translate(-2px, -2px);
            border-color: var(--black);
        }
    </style>
</head>

<body class="max-w-md mx-auto p-4 flex flex-col bg-background">
    <div id="toastContainer"></div>

    <div id="loadingOverlay">
        <div class="w-10 h-10 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loadText" class="text-xs text-white tracking-widest uppercase">
            Loading...
        </p>
    </div>

    <div id="missionReport" style="display: none;" onclick="this.style.display='none'">
        <div class="mission-card">
            <p class="font-bold tracking-widest uppercase text-xs mb-2">Refill Complete</p>
            <h2 class="text-3xl font-black tracking-tighter">Log Confirmed</h2>
            <div id="grade" class="grade-badge">A</div>
            <div class="grid grid-cols-2 gap-4 text-center my-4 w-full">
                <div>
                    <p class="text-xs uppercase font-bold">Efficiency</p>
                    <p id="effVal" class="text-2xl font-black">-- <span class="text-xs">KM/L</span></p>
                </div>
                <div>
                    <p class="text-xs uppercase font-bold">Trend</p>
                    <p id="effTrend" class="text-2xl font-black text-black">STABLE</p>
                </div>
            </div>
            <p class="text-xs mt-6 uppercase">Tap to close</p>
        </div>
    </div>

    <header class="flex justify-between items-center mb-4 card p-2">
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()" class="btn btn-secondary p-2 text-xl leading-none">
                üåì
            </button>
            <h1 class="text-xl font-black tracking-tighter">
                Fuel Log AI
            </h1>
        </div>
        <div class="flex gap-2">
            <button onclick="openScanner(true)" class="btn btn-secondary px-3 py-2 text-sm">
                üì∑
            </button>
            <button onclick="openScanner(false)" class="btn btn-secondary px-3 py-2 text-sm">
                üìÅ
            </button>
            <button onclick="ref()" class="btn btn-secondary px-3 py-2 text-sm">
                üîÑ
            </button>
        </div>
        <input type="file" id="cam" accept="image/*" class="hidden" onchange="processImage(event)" />
    </header>

    <main class="flex-1 overflow-hidden">
        <div id="tab0" class="tab-panel active">
            <form id="f" onsubmit="sub(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="!mb-0">Vehicle</label>
                            <button type="button" onclick="addVehicle()"
                                class="text-xs font-bold uppercase tracking-wider">+ Add</button>
                        </div>
                        <select name="vehicle_name" id="vehicleSelect" class="h-12 font-bold"></select>
                        <div id="vehicleRadioGroup" class="vehicle-radio-group"></div>
                    </div>
                    <div>
                        <label>‚õΩ Type</label>
                        <select name="fuel_type" id="fuelType" class="h-12 font-bold">
                            <option value="petrol">Petrol</option>
                            <option value="diesel">Diesel</option>
                            <option value="cng">CNG</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 items-center">
                    <div class="card p-3">
                        <label>üèéÔ∏è Odometer</label>
                        <input type="number" name="km_reading" id="k" step="0.1" inputmode="decimal" required
                            class="mt-1" />
                    </div>
                    <div class="card p-3 h-full flex flex-col justify-center items-center gap-1">
                        <label>Status</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="full_tank" id="ft" class="w-5 h-5 accent-yellow-400" checked />
                            <span class="text-sm font-bold">Full Tank</span>
                        </div>
                    </div>
                </div>

                <div class="card p-4 space-y-2">
                    <div class="grid grid-cols-[1fr_auto_1fr] items-end gap-x-3">
                        <div>
                            <label>Quantity (L)</label>
                            <input type="number" name="fuel_qty" id="q" step="0.01" inputmode="decimal" required
                                oninput="calc()" />
                        </div>
                        <div class="text-3xl font-black pb-2">√ó</div>
                        <div>
                            <label>Price / L</label>
                            <input type="number" name="fuel_price" id="p" step="0.01" inputmode="decimal" required
                                oninput="calc()" />
                        </div>
                    </div>
                    <div id="total_cost_card" class="card p-3">
                        <div class="flex justify-between items-center">
                            <label class="!mb-0">Total:</label>
                            <div class="text-right text-3xl font-black">
                                <span>‚Çπ</span>
                                <span id="t_display">0.00</span>
                                <input type="hidden" name="refill_amount" id="t" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" name="refill_date" id="d" required class="font-bold" />
                    <div>
                        <label>üìç Station</label>
                        <div class="flex items-center relative">
                            <input type="text" name="pump_location" id="l" list="stationOptions" 
                                placeholder="Select or type..."
                                autocomplete="off"
                                class="font-bold rounded-r-none" />
                            <datalist id="stationOptions">
                                </datalist>
                            <button type="button" onclick="fetchGPS()"
                                class="btn h-12 w-12 rounded-l-none text-2xl flex-shrink-0 p-0">
                                üìç
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <label>Notes</label>
                    <textarea name="notes" id="n" placeholder="Additional details..." rows="2" class="resize-none"></textarea>
                </div>

                <button type="submit" id="s" class="w-full py-5 btn text-xl">
                    Save Log
                </button>
            </form>
        </div>

        <div id="tab1" class="tab-panel">
            <div class="card overflow-hidden">
                <div id="logList" class="card overflow-hidden flex flex-col">
                    </div>
            </div>
        </div>

        <div id="tab2" class="tab-panel space-y-4">
            <div id="statsGrid" class="grid gap-3"></div>
            <div class="p-3 card">
                <canvas id="effChart"></canvas>
            </div>
        </div>

        <div id="tab3" class="tab-panel space-y-4">
            <div class="text-center card p-4">
                <p id="mCity" class="text-sm font-bold uppercase tracking-widest">
                    Loading...
                </p>
                <div id="mInsight" class="text-lg font-bold mt-2"></div>
            </div>
            <div id="mMarket" class="grid grid-cols-2 gap-3 text-center"></div>
            <div id="mSources" class="space-y-2"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-card-bg border-t-4 border-border-color grid grid-cols-4 h-16 z-50">
        <button onclick="setTab(0)"
            class="nav-btn flex flex-col items-center justify-center nav-active font-bold text-[0.65rem] uppercase border-r-2 border-l-2 border-border-color">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Add
        </button>
        <button onclick="setTab(1)"
            class="nav-btn flex flex-col items-center justify-center text-gray-500 font-bold text-[0.65rem] uppercase border-r-2 border-border-color">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
            Logs
        </button>
        <button onclick="setTab(2)"
            class="nav-btn flex flex-col items-center justify-center text-gray-500 font-bold text-[0.65rem] uppercase border-r-2 border-border-color">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
            Stats
        </button>
        <button onclick="setTab(3)"
            class="nav-btn flex flex-col items-center justify-center text-gray-500 font-bold text-[0.65rem] uppercase border-r-2 border-border-color">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Market
        </button>
    </nav>

    <script>
        let logs = [];
        let chart = null;
        let vehicleList = [];
        let lastUserPrice = 0;
        const colors = ["#1a1a1a", "#fde047", "#28a745", "#dc3545", "#fd7e14"];

        function showLoading(t) {
            document.getElementById("loadText").textContent = t;
            document.getElementById("loadingOverlay").style.display = "flex";
        }
        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        function showToast(text) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        }

        function handleError(err) {
            hideLoading();
            const msg = err.message || "An error occurred. Please try again.";
            showToast("ERROR: " + msg);
            console.error(err);
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
            document.getElementById("d").value = new Date().toISOString().split("T")[0];
            
            // Auto-fetch GPS silently
            if (navigator.geolocation && !document.getElementById("l").value) {
                navigator.geolocation.getCurrentPosition((p) => {
                    // Do nothing, just ensure permissions are ready
                }, (err) => {
                    console.log("Auto-GPS failed", err);
                }, { timeout: 5000 });
            }

            ref();
        };

        function addVehicle() {
            const n = prompt("Enter a name for the new vehicle:");
            if (n && n.trim()) {
                const s = document.getElementById("vehicleSelect");
                s.add(new Option(n.trim(), n.trim()));
                s.value = n.trim();
            }
        }

        function setTab(idx) {
            document.querySelectorAll(".tab-panel").forEach((p, i) => p.classList.toggle("active", i === idx));
            document.querySelectorAll(".nav-btn").forEach((b, i) => {
                b.classList.toggle("nav-active", i === idx);
                b.classList.toggle("text-gray-500", i !== idx);
            });
            if (idx === 1) rend();
            if (idx === 2) stats();
            if (idx === 3) loadMarket();
        }

        function ref() {
            showLoading("Syncing data...");
            google.script.run
                .withSuccessHandler((res) => {
                    hideLoading();
                    if (res.success) {
                        logs = res.data;
                        vehicleList = res.vehicles;
                        lastUserPrice = res.lastPrice;

                        // ----------------------------------------------------
                        // POPULATE STATION DROPDOWN
                        // ----------------------------------------------------
                        const stationSet = new Set(logs.map(l => l.pump_location).filter(s => s && s.trim() !== ""));
                        // Add NEW to the set so it appears in list
                        stationSet.add("NEW");
                        const stationArr = Array.from(stationSet).sort();
                        
                        const dl = document.getElementById('stationOptions');
                        dl.innerHTML = stationArr.map(s => `<option value="${s}">`).join('');

                        // DO NOT PRE-FILL "NEW". 
                        // Leaving it empty ensures valid dropdown behavior.

                        // Smart pre-fill price
                        if (lastUserPrice > 0 && !document.getElementById('p').value) {
                            document.getElementById('p').value = lastUserPrice;
                        }

                        const s = document.getElementById("vehicleSelect");
                        s.innerHTML = '';
                        if (res.vehicles.length > 0) {
                            res.vehicles.forEach((v) => s.add(new Option(v, v)));
                        } else {
                            s.add(new Option("My Car", "My Car"));
                        }

                        // Smart Selector Logic with Custom Colors
                        const rg = document.getElementById("vehicleRadioGroup");
                        if (vehicleList.length > 0 && vehicleList.length <= 4) {
                            s.style.display = 'none';
                            rg.style.display = 'flex';
                            rg.innerHTML = '';
                            vehicleList.forEach(v => {
                                const div = document.createElement('div');
                                div.className = 'vehicle-radio';
                                
                                // Apply color classes based on name
                                const vName = v.toLowerCase();
                                if (vName.includes('kylaq')) div.classList.add('btn-kylaq');
                                else if (vName.includes('octavia')) div.classList.add('btn-octavia');
                                
                                div.textContent = v;
                                div.onclick = () => {
                                    s.value = v;
                                    document.querySelectorAll('.vehicle-radio').forEach(d => d.classList.remove('selected'));
                                    div.classList.add('selected');
                                };
                                rg.appendChild(div);
                            });
                            // Sync initial selection
                            if (s.value) {
                                const match = Array.from(rg.children).find(c => c.textContent === s.value);
                                if (match) match.classList.add('selected');
                            }
                        } else {
                            s.style.display = 'block';
                            rg.style.display = 'none';
                        }
                    } else {
                        showToast("Database Sync Failed.");
                    }
                })
                .withFailureHandler(handleError)
                .getDataProtocol();
        }

        function calc() {
            const q = parseFloat(document.getElementById("q").value) || 0;
            const p = parseFloat(document.getElementById("p").value) || 0;
            const total = (q * p).toFixed(2);
            document.getElementById("t").value = total;
            document.getElementById("t_display").textContent = total;
        }

        function sub(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            data.full_tank = document.getElementById("ft").checked;
            
            // Default Station to NEW if empty
            if (!data.pump_location || data.pump_location.trim() === "") {
                data.pump_location = "NEW";
            }

            showLoading("Saving entry...");
            google.script.run
                .withSuccessHandler(() => {
                    hideLoading();
                    showMissionReport(data);
                    e.target.reset();
                    document.getElementById("d").value = new Date().toISOString().split("T")[0];
                    // Clean reset
                    document.getElementById("l").value = ""; 
                    setTimeout(ref, 3000);
                })
                .withFailureHandler(handleError)
                .saveEntryDirect(data);
        }

        function showMissionReport(currentEntry) {
            const el = document.getElementById("missionReport");
            if (!el) return;

            document.getElementById("effVal").innerHTML = `-- <span class="text-xs">KM/L</span>`;
            document.getElementById("effTrend").textContent = "STABLE";
            document.getElementById("effTrend").className = "text-2xl font-black";
            document.getElementById("grade").textContent = "B";

            try {
                const vName = currentEntry.vehicle_name;
                const vLogs = logs.filter(l => l.vehicle_name === vName);

                if (vLogs.length > 0) {
                    const last = vLogs[0];
                    const dist = parseFloat(currentEntry.km_reading) - parseFloat(last.km_reading);
                    const fuel = parseFloat(currentEntry.fuel_qty);

                    if (dist > 0 && fuel > 0) {
                        const eff = (dist / fuel).toFixed(1);
                        document.getElementById("effVal").innerHTML = `${eff} <span class="text-xs">KM/L</span>`;

                        let grade = "C";
                        if (eff > 15) grade = "B";
                        if (eff > 18) grade = "A";
                        if (eff > 22) grade = "S";
                        document.getElementById("grade").textContent = grade;

                        if (logs.length > 1) {
                            const prevDist = logs[0].km_reading - logs[1].km_reading;
                            const prevFuel = logs[0].fuel_qty;
                            const prevEff = prevDist / prevFuel;
                            if (prevEff > 0) {
                                const diff = ((eff - prevEff) / prevEff * 100).toFixed(1);
                                document.getElementById("effTrend").textContent = (diff > 0 ? "+" : "") + diff + "%";
                            }
                        }
                    }
                }
            } catch (err) {
                console.warn("HUD Calculation Error:", err);
            }

            el.style.display = 'flex';
            setTimeout(() => { el.style.display = "none"; }, 6000);
        }

        function rend() {
            const b = document.getElementById("logList");
            if (logs.length === 0) {
                b.innerHTML = `<div class="text-center p-8 text-gray-500 font-bold">No logs yet. Add your first entry!</div>`;
                return;
            }
            b.innerHTML = "";
            logs.slice(0, 50).forEach((e, i) => {
                const date = e.refill_date.split("T")[0];
                const isFull = e.full_tank == true || e.full_tank == "true";

                // Efficiency Dot Logic
                let effDot = '';
                if (isFull) {
                    const prev = logs.slice(i + 1).find(l => l.vehicle_name === e.vehicle_name);
                    if (prev) {
                        const dist = (parseFloat(e.km_reading) || 0) - (parseFloat(prev.km_reading) || 0);
                        const qty = parseFloat(e.fuel_qty) || 1;
                        if (dist > 0 && qty > 0) {
                            const eff = dist / qty;
                            let color = 'bg-red-500';
                            if (eff >= 10) color = 'bg-yellow-500';
                            if (eff >= 15) color = 'bg-green-500';
                            effDot = `<div class="w-3 h-3 rounded-full ${color} shadow-sm border border-black/20" title="${eff.toFixed(1)} KM/L"></div>`;
                        }
                    }
                }

                b.innerHTML += `
                <div class="log-card">
                    <div>
                        <div class="log-date">${date}</div>
                        <div class="log-vehicle flex items-center gap-2">
                            ${e.vehicle_name}
                            ${effDot}
                        </div>
                        <div class="log-details">
                            <span class="font-bold border-2 border-[var(--border-color)] px-1 rounded text-xs">${parseFloat(e.fuel_qty).toFixed(2)}L</span>
                            <span>‚Ä¢</span>
                            <span class="${isFull ? 'text-green-600' : 'text-orange-500'}">${isFull ? 'FULL' : 'PARTIAL'}</span>
                        </div>
                        ${e.notes ? `<div class="text-[0.65rem] opacity-70 italic mt-1 font-medium truncate max-w-[200px]">${e.notes}</div>` : ''}
                    </div>
                    <div class="flex flex-col justify-center items-end">
                         <div class="log-cost">‚Çπ${parseFloat(e.refill_amount).toFixed(0)}</div>
                         <div class="text-xs font-bold opacity-60">‚Çπ${parseFloat(e.fuel_price).toFixed(2)}/L</div>
                    </div>
                </div>`;
            });
        }

        function stats() {
            const container = document.getElementById("statsGrid");
            container.innerHTML = "";
            const datasets = [];
            vehicleList.forEach((vName, idx) => {
                const vLogs = logs.filter((e) => e.vehicle_name === vName).reverse();
                if (vLogs.length < 2) return;

                const fuel = vLogs.reduce((s, e) => s + (parseFloat(e.fuel_qty) || 0), 0);
                const odos = vLogs.map((e) => parseFloat(e.km_reading) || 0);
                const dist = Math.max(...odos) - Math.min(...odos);
                const eff = dist > 0 ? (dist / fuel).toFixed(2) : "0.0";
                const color = colors[idx % colors.length];

                container.innerHTML += `
                    <div class="card p-4 flex justify-between items-center">
                        <span class="text-sm font-black uppercase">${vName}</span>
                        <span class="text-2xl font-black" style="color: ${color}">${eff} <span class="text-xs">KM/L</span></span>
                    </div>`;

                const chartData = [];
                for (let i = 1; i < vLogs.length; i++) {
                    const d = vLogs[i].km_reading - vLogs[i - 1].km_reading;
                    const f = vLogs[i].fuel_qty;
                    if (d > 0 && f > 0 && (vLogs[i].full_tank == true || vLogs[i].full_tank == "true")) {
                        chartData.push({
                            x: vLogs[i].refill_date.split("T")[0].slice(5),
                            y: (d / f).toFixed(2),
                            _cost: parseFloat(vLogs[i].refill_amount).toFixed(0),
                            _full: vLogs[i].full_tank
                        });
                    }
                }
                datasets.push({
                    label: vName,
                    data: chartData,
                    borderColor: color,
                    backgroundColor: "#00000011",
                    tension: 0.1,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                });
            });

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById("effChart"), {
                type: "line",
                data: { datasets: datasets },
                options: {
                    scales: {
                        y: { grid: { color: "#00000022" }, ticks: { color: "black", font: { size: 10, weight: '800' } } },
                        x: { type: "category", grid: { display: false }, ticks: { color: "black", font: { size: 10, weight: '800' } } },
                    },
                    plugins: { legend: { labels: { color: "black", font: { size: 12, weight: "800" } } } },
                    onClick: (e, activeEls, chart) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            const datasetIdx = activeEls[0].datasetIndex;
                            const point = chart.data.datasets[datasetIdx].data[idx];
                            showToast(`Log: ${point.x} - ‚Çπ${point._cost} (${point.y} KM/L)`);
                        }
                    }
                },
            });
        }

        function loadMarket() {
            showLoading("Checking market...");
            navigator.geolocation.getCurrentPosition((p) => {
                google.script.run
                    .withSuccessHandler((res) => {
                        hideLoading();
                        if (!res || !res.success) return;
                        const m = res.market;
                        document.getElementById("mCity").textContent = "Region: " + m.city.toUpperCase();
                        document.getElementById("mInsight").textContent = m.insight;
                        document.getElementById("mMarket").innerHTML = `
                        <div class="card p-4"><p class="text-sm font-bold uppercase">Petrol</p><p class="text-3xl font-black">‚Çπ${m.petrol}</p></div>
                        <div class="card p-4"><p class="text-sm font-bold uppercase">Diesel</p><p class="text-3xl font-black">‚Çπ${m.diesel}</p></div>`;
                        document.getElementById("mSources").innerHTML = m.sources.map((s) =>
                            `<a href="${s.url}" target="_blank" class="block p-3 card text-xs font-bold uppercase">Source: ${s.title} ‚Üó</a>`
                        ).join("");
                    })
                    .withFailureHandler(handleError)
                    .getMarketData(p.coords.latitude, p.coords.longitude, lastUserPrice);
            }, (err) => {
                hideLoading();
                showToast("Location Access Denied.");
            }, { enableHighAccuracy: true, timeout: 5000 });
        }

        function fetchGPS() {
            navigator.geolocation.getCurrentPosition((p) => {
                document.getElementById("l").value = `${p.coords.latitude.toFixed(3)},${p.coords.longitude.toFixed(3)}`;
            }, (err) => {
                showToast("GPS Signal Blocked.");
            }, { enableHighAccuracy: true, timeout: 5000 });
        }

        function openScanner(forceCam) {
            const input = document.getElementById('cam');
            if (forceCam) {
                input.setAttribute('capture', 'environment');
            } else {
                input.removeAttribute('capture');
            }
            input.click();
        }

        function processImage(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const i = new Image();
                i.onload = () => {
                    const c = document.createElement("canvas");
                    let w = i.width, h = i.height;
                    const max_size = 800;
                    if (w > max_size || h > max_size) {
                        if (w > h) {
                            h *= max_size / w;
                            w = max_size;
                        } else {
                            w *= max_size / h;
                            h = max_size;
                        }
                    }
                    c.width = w;
                    c.height = h;
                    c.getContext("2d").drawImage(i, 0, 0, w, h);
                    showLoading("Processing receipt...");
                    google.script.run
                        .withSuccessHandler((res) => {
                            hideLoading();
                            if (res && res.success) {
                                const fieldMap = {
                                    'fuel_qty': 'q',
                                    'fuel_price': 'p',
                                    'refill_date': 'd',
                                    'notes': 'n'
                                };
                                
                                // Auto-fill fields
                                Object.keys(fieldMap).forEach(key => {
                                    const elId = fieldMap[key];
                                    const el = document.getElementById(elId);
                                    if (res.data[key] && el) {
                                        el.value = res.data[key];
                                        el.classList.add('border-yellow-400', 'ring-2', 'ring-yellow-200');
                                        setTimeout(() => el.classList.remove('border-yellow-400', 'ring-2', 'ring-yellow-200'), 3000);
                                    }
                                });

                                // APPEND GPS TO NOTES (Requested Feature)
                                const notesField = document.getElementById('n');
                                const aiNotes = res.data.notes || "";
                                
                                navigator.geolocation.getCurrentPosition(
                                    (pos) => {
                                        const gpsString = `GPS: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                                        // Combine AI notes + GPS
                                        notesField.value = aiNotes ? `${aiNotes} | ${gpsString}` : gpsString;
                                        showToast("SCANNED + GPS ADDED");
                                    },
                                    (err) => {
                                        // Fallback if GPS fails: just show AI notes
                                        console.warn("GPS failed during scan", err);
                                        // Ensure notes are set even if GPS fails
                                        if (aiNotes) notesField.value = aiNotes;
                                        showToast("SCANNED (NO GPS)");
                                    },
                                    { timeout: 4000, enableHighAccuracy: true }
                                );

                                calc();
                            } else {
                                showToast("AI SCANNED FAILED. ENTER MANUALLY.");
                            }
                        })
                        .withFailureHandler(handleError)
                        .processReceiptWithAI(c.toDataURL("image/jpeg", 0.7).split(",")[1]);
                };
                i.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }
    </script>
</body>

</html>
