<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Fuel Log AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@800&display=swap");

        :root {
            font-size: 16px;
            --primary: #FFDE03;
            --black: #1a1a1a;
            --white: #ffffff;
            --bg: #F4F4F4;
            --card-bg: var(--white);
            --text: var(--black);
            --border: var(--black);
            --shadow: var(--black);
            --input-bg: var(--white);
            --invert-icon: 0;
        }

        [data-theme="dark"] {
            --primary: #fde047;
            --black: #000000;
            --white: #1e1e1e;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --border: #404040;
            --shadow: #000000;
            --input-bg: #2a2a2a;
            --invert-icon: 1;
        }

        body {
            font-family: "Inter", sans-serif;
            font-weight: 600;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100svh;
            transition: all 0.3s ease;
        }

        .neo-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 3px 3px 0px var(--shadow);
        }

        .neo-input {
            background: var(--input-bg) !important;
            border: 2px solid var(--border) !important;
            color: var(--text) !important;
            padding: 10px 12px !important;
            width: 100%;
            border-radius: 8px;
            font-size: 16px !important;
            font-weight: 600;
            box-shadow: 2px 2px 0px var(--shadow);
            transition: all 0.2s ease;
        }

        .neo-input:focus {
            outline: none;
            border-color: var(--primary) !important;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0px var(--shadow);
        }

        input::-webkit-calendar-picker-indicator {
            opacity: 1 !important;
            filter: invert(var(--invert-icon));
        }

        .neo-btn {
            background-color: var(--primary);
            color: var(--black);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 3px 3px 0px var(--shadow);
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            cursor: pointer;
            padding: 12px;
        }

        .neo-btn:active {
            transform: scale(0.95) translate(2px, 2px);
            box-shadow: 0px 0px 0px var(--shadow);
        }

        .neo-btn-secondary {
            background-color: var(--card-bg);
            color: var(--text);
        }

        #total_cost_card {
            background-color: var(--primary);
            color: var(--black);
            box-shadow: 2px 2px 0px var(--shadow);
        }

        /* Specific Vehicle Colors */
        .btn-kylaq {
            background-color: #22c55e !important;
            /* Green */
            color: white !important;
            border-color: #14532d !important;
        }

        .btn-octavia {
            background-color: #ef4444 !important;
            /* Red */
            color: white !important;
            border-color: #7f1d1d !important;
        }

        /* Toast System */
        #toastContainer {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            width: 100%;
            max-width: 320px;
        }

        .toast {
            background: var(--primary);
            color: var(--black);
            border: 2px solid var(--black);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 800;
            box-shadow: 3px 3px 0px var(--black);
            text-transform: uppercase;
            font-size: 0.8rem;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.3s forwards 2.7s;
            pointer-events: auto;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                transform: translateY(-20px);
                opacity: 0;
            }
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(2px);
        }

        #missionReport {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 300;
            justify-content: flex-end;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .mission-card {
            background: var(--primary);
            color: var(--black);
            border: 2px solid var(--black);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            width: 100%;
            max-width: 448px;
            padding: 2rem 2rem 4rem 2rem;
            text-align: center;
            box-shadow: 0px -4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }


        .grade-badge {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            margin: 1rem 0;
            color: var(--black);
        }

        .tab-panel {
            display: none;
            height: calc(100svh - 160px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .tab-panel.active {
            display: block;
        }

        .nav-active {
            background: var(--primary);
            box-shadow: inset 2px 2px 0px #00000033;
        }

        table {
            width: 100%;
            font-size: 0.85rem;
        }

        th {
            color: var(--text);
            background: var(--card-bg);
            border-bottom: 2px solid var(--border);
            padding: 10px;
            text-align: left;
            font-weight: 800;
            text-transform: uppercase;
        }

        td {
            padding: 12px 10px;
            border-bottom: 2px solid var(--border);
        }

        .nav-btn {
            transition: background-color 0.2s ease;
        }

        .nav-btn:active {
            background: var(--primary);
            opacity: 0.8;
        }

        .log-card {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 2px solid var(--border);
            background: var(--card-bg);
            transition: background-color 0.2s;
        }

        .log-card:last-child {
            border-bottom: none;
        }

        .log-card:active {
            background-color: var(--bg);
        }

        .log-date {
            font-size: 0.7rem;
            font-weight: 800;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        .log-vehicle {
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
        }

        .log-cost {
            font-size: 1.25rem;
            font-weight: 900;
            text-align: right;
        }

        .log-details {
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 4px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        /* Tab Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Smart Vehicle Selector */
        .vehicle-radio-group {
            display: none;
            gap: 0.5rem;
        }

        .vehicle-radio {
            flex: 1;
            padding: 1rem;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .vehicle-radio.selected {
            background: var(--primary);
            color: var(--black);
            opacity: 1;
            box-shadow: 3px 3px 0px var(--shadow);
            transform: translate(-2px, -2px);
            border-color: var(--black);
        }
    </style>
</head>

<body class="max-w-md mx-auto p-4 flex flex-col bg-[var(--bg)]">
    <div id="toastContainer"></div>

    <div id="loadingOverlay">
        <div class="w-10 h-10 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loadText" class="text-xs text-white tracking-widest uppercase">
            Loading...
        </p>
    </div>

    <div id="missionReport" style="display: none;" onclick="this.style.display='none'">
        <div class="mission-card">
            <p class="font-bold tracking-widest uppercase text-xs mb-2">Refill Complete</p>
            <h2 class="text-3xl font-black tracking-tighter">Log Confirmed</h2>
            <div id="grade" class="grade-badge">A</div>
            <div class="grid grid-cols-2 gap-4 text-center my-4 w-full">
                <div>
                    <p class="text-xs uppercase font-bold">Efficiency</p>
                    <p id="effVal" class="text-2xl font-black">-- <span class="text-xs">KM/L</span></p>
                </div>
                <div>
                    <p class="text-xs uppercase font-bold">Trend</p>
                    <p id="effTrend" class="text-2xl font-black text-black">STABLE</p>
                </div>
            </div>
            <p class="text-xs mt-6 uppercase">Tap to close</p>
        </div>
    </div>

    <header class="flex justify-between items-center mb-4 neo-card p-2">
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()" class="neo-btn neo-btn-secondary p-2 text-xl leading-none">
                üåì
            </button>
            <h1 class="text-xl font-black tracking-tighter">
                Fuel Log AI
            </h1>
        </div>
        <div class="flex gap-2">
            <button onclick="openScanner(true)" class="neo-btn p-3 text-2xl leading-none" title="Take Photo">
                üì∑
            </button>
            <button onclick="openScanner(false)" class="neo-btn p-3 text-2xl leading-none" title="Browse Photo">
                üìÅ
            </button>
        </div>

        <input type="file" id="cam" accept="image/*" class="hidden" onchange="processImage(event)" />
    </header>

    <main class="flex-1 overflow-hidden">
        <div id="tab0" class="tab-panel active">
            <form id="f" onsubmit="sub(event)" class="space-y-4">
                <div class="neo-card overflow-hidden">
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="!mb-0 text-[0.7rem] uppercase">Vehicle</label>
                                    <button type="button" onclick="addVehicle()"
                                        class="text-[0.6rem] font-black uppercase tracking-widest text-[#FF4646]">+
                                        New</button>
                                </div>
                                <select name="vehicle_name" id="vehicleSelect" class="neo-input font-black h-11"></select>
                                <div id="vehicleRadioGroup" class="vehicle-radio-group"></div>
                            </div>
                            <div>
                                <label class="text-[0.7rem] uppercase">‚õΩ Fuel Type</label>
                                <select name="fuel_type" id="fuelType" class="neo-input font-black h-11">
                                    <option value="petrol">Petrol</option>
                                    <option value="diesel">Diesel</option>
                                    <option value="cng">CNG</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 items-end">
                            <div>
                                <label class="text-[0.7rem] uppercase">üèéÔ∏è Odometer (KM)</label>
                                <input type="number" name="km_reading" id="k" step="0.1" inputmode="decimal" required
                                    class="neo-input h-11" />
                            </div>
                            <div
                                class="flex items-center gap-3 h-11 px-3 border-2 border-[var(--border)] rounded-lg bg-[var(--input-bg)]">
                                <input type="checkbox" name="full_tank" id="ft" class="w-5 h-5 accent-yellow-400" checked />
                                <span class="text-xs font-black uppercase whitespace-nowrap">Full Tank</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-[var(--primary)]/10 border-t-2 border-[var(--border)]">
                        <div class="grid grid-cols-[1fr_auto_1fr] items-center gap-3 mb-3">
                            <div>
                                <label class="text-[0.7rem] uppercase">Quantity (L)</label>
                                <input type="number" name="fuel_qty" id="q" step="0.01" inputmode="decimal" required
                                    oninput="calc()" class="neo-input !bg-white !text-black h-11" />
                            </div>
                            <div class="text-2xl font-black mt-4">√ó</div>
                            <div>
                                <label class="text-[0.7rem] uppercase">Price / L</label>
                                <input type="number" name="fuel_price" id="p" step="0.01" inputmode="decimal" required
                                    oninput="calc()" class="neo-input !bg-white !text-black h-11" />
                            </div>
                        </div>
                        <div id="total_cost_card"
                            class="p-3 border-dashed border-2 border-[var(--border)] rounded-lg flex justify-between items-center bg-[var(--primary)] text-[var(--black)]">
                            <span class="text-xs font-black uppercase">Total Amount</span>
                            <div class="text-2xl font-black">
                                <span>‚Çπ</span><span id="t_display">0.00</span>
                                <input type="hidden" name="refill_amount" id="t" />
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t-2 border-[var(--border)] bg-[var(--bg)]/30">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" name="refill_date" id="d" required class="neo-input h-11" />
                            <div class="flex relative">
                                <input type="text" name="pump_location" id="l" list="stationOptions"
                                    placeholder="üìç Station Location" autocomplete="off"
                                    class="neo-input h-11 rounded-r-none pr-10" />
                                <datalist id="stationOptions"></datalist>
                                <button type="button" onclick="fetchGPS()"
                                    class="neo-btn h-11 w-11 p-0 absolute right-0 rounded-l-none border-l-0 text-xl leading-none shadow-none translate-y-0 active:translate-y-0">üìç</button>
                            </div>
                        </div>
                    </div>
                </div>

                <textarea name="notes" id="n" placeholder="üìù Additional Notes (AI results appear here)..." rows="2"
                    class="neo-input text-sm"></textarea>

                <button type="submit" id="s" class="neo-btn w-full py-4 text-xl tracking-tighter">Save Log
                    Entry</button>
            </form>
        </div>

        <div id="tab1" class="tab-panel">
            <div class="neo-card overflow-hidden">
                <div id="logList" class="flex flex-col">
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-panel space-y-4">
            <div id="statsGrid" class="grid gap-4"></div>
            <div class="p-3 neo-card">
                <canvas id="effChart"></canvas>
            </div>
        </div>

        <div id="tab3" class="tab-panel space-y-4">
            <div class="text-center neo-card p-4">
                <p id="mCity" class="text-[0.7rem] font-black uppercase tracking-widest opacity-70">
                    Locating...
                </p>
                <div id="mInsight" class="text-lg font-black mt-1 leading-tight"></div>
            </div>
            <div id="mMarket" class="grid grid-cols-2 gap-4 text-center"></div>
            <div id="mSources" class="space-y-3"></div>
        </div>
    </main>

    <nav
        class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] border-t-4 border-[var(--border)] grid grid-cols-4 h-16 z-50">
        <button onclick="setTab(0)"
            class="nav-btn flex flex-col items-center justify-center nav-active font-black text-[0.6rem] uppercase border-r-2 border-[var(--border)]">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Add
        </button>
        <button onclick="setTab(1)"
            class="nav-btn flex flex-col items-center justify-center text-gray-400 font-black text-[0.6rem] uppercase border-r-2 border-[var(--border)]">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
            Logs
        </button>
        <button onclick="setTab(2)"
            class="nav-btn flex flex-col items-center justify-center text-gray-400 font-black text-[0.6rem] uppercase border-r-2 border-[var(--border)]">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
            Stats
        </button>
        <button onclick="setTab(3)"
            class="nav-btn flex flex-col items-center justify-center text-gray-400 font-black text-[0.6rem] uppercase border-r-2 border-[var(--border)]">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="nav-icon">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Market
        </button>
    </nav>

    <script>
        const state = {
            logs: [],
            vehicles: [],
            lastPrice: 0,
            chart: null,
            colors: ["#1a1a1a", "#fde047", "#28a745", "#dc3545", "#fd7e14"]
        };

        const ui = {
            loading: (t) => {
                document.getElementById("loadText").textContent = t;
                document.getElementById("loadingOverlay").style.display = "flex";
            },
            hideLoading: () => document.getElementById("loadingOverlay").style.display = "none",
            toast: (text) => {
                const container = document.getElementById('toastContainer');
                const t = document.createElement('div');
                t.className = 'toast';
                t.textContent = text;
                container.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
        };

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
            document.getElementById("d").value = new Date().toISOString().split("T")[0];
            // Auto-fetch GPS silently
            if (navigator.geolocation && !document.getElementById("l").value) {
                navigator.geolocation.getCurrentPosition((p) => {
                    // Do nothing, just ensure permissions are ready
                }, (err) => {
                    console.log("Auto-GPS failed", err);
                }, { timeout: 5000 });
            }
            ref();
        };

        function addVehicle() {
            const n = prompt("Enter vehicle name:");
            if (n?.trim()) {
                const s = document.getElementById("vehicleSelect");
                s.add(new Option(n.trim(), n.trim()));
                s.value = n.trim();
            }
        }

        function setTab(idx) {
            document.querySelectorAll(".tab-panel").forEach((p, i) => p.classList.toggle("active", i === idx));
            document.querySelectorAll(".nav-btn").forEach((b, i) => {
                b.classList.toggle("nav-active", i === idx);
                b.classList.toggle("text-gray-400", i !== idx);
            });
            if (idx === 1) rend();
            if (idx === 2) stats();
            if (idx === 3) loadMarket();
        }

        function ref() {
            ui.loading("Syncing...");
            google.script.run
                .withSuccessHandler((res) => {
                    ui.hideLoading();
                    if (!res.success) return ui.toast("Sync Failed");

                    state.logs = res.data;
                    state.vehicles = res.vehicles;
                    state.lastPrice = res.lastPrice;

                    // Update Station Options
                    const stations = [...new Set(state.logs.map(l => l.pump_location).filter(s => s?.trim()))].sort();
                    document.getElementById('stationOptions').innerHTML = stations.map(s => `<option value="${s}">`).join('');

                    // Prefill Price
                    if (state.lastPrice > 0 && !document.getElementById('p').value) {
                        document.getElementById('p').value = state.lastPrice;
                    }

                    // Populate Vehicles
                    const s = document.getElementById("vehicleSelect");
                    s.innerHTML = state.vehicles.length ? '' : '<option value="My Car">My Car</option>';
                    state.vehicles.forEach(v => s.add(new Option(v, v)));

                    // Vehicle Radios (Smart Selector)
                    const rg = document.getElementById("vehicleRadioGroup");
                    if (state.vehicles.length > 0 && state.vehicles.length <= 4) {
                        s.style.display = 'none';
                        rg.style.display = 'flex';
                        rg.innerHTML = state.vehicles.map(v => {
                            const cls = v.toLowerCase().includes('kylaq') ? 'btn-kylaq' : (v.toLowerCase().includes('octavia') ? 'btn-octavia' : '');
                            return `<div class="vehicle-radio ${cls}" onclick="selectVehicle('${v}', this)">${v}</div>`;
                        }).join('');

                        const active = Array.from(rg.children).find(c => c.textContent === s.value);
                        if (active) active.classList.add('selected');
                    } else {
                        s.style.display = 'block';
                        rg.style.display = 'none';
                    }
                })
                .withFailureHandler(err => { ui.hideLoading(); ui.toast("Error: " + err.message); })
                .getDataProtocol();
        }

        function selectVehicle(v, el) {
            document.getElementById("vehicleSelect").value = v;
            document.querySelectorAll('.vehicle-radio').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        function calc() {
            const q = parseFloat(document.getElementById("q").value) || 0;
            const p = parseFloat(document.getElementById("p").value) || 0;
            const total = (q * p).toFixed(2);
            document.getElementById("t").value = total;
            document.getElementById("t_display").textContent = total;
        }

        function sub(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            data.full_tank = document.getElementById("ft").checked;
            if (!data.pump_location?.trim()) data.pump_location = "NEW";

            ui.loading("Saving...");
            google.script.run
                .withSuccessHandler(() => {
                    ui.hideLoading();
                    showMissionReport(data);
                    e.target.reset();
                    document.getElementById("d").value = new Date().toISOString().split("T")[0];
                    // Clean reset
                    document.getElementById("l").value = "";
                    setTimeout(ref, 3000);
                })
                .withFailureHandler(err => { ui.hideLoading(); ui.toast("Error: " + err.message); })
                .saveEntryDirect(data);
        }

        function showMissionReport(entry) {
            const el = document.getElementById("missionReport");
            const vLogs = state.logs.filter(l => l.vehicle_name === entry.vehicle_name);

            let eff = "--", grade = "B", trend = "STABLE", trendClass = "text-2xl font-black";

            if (vLogs.length > 0) {
                const dist = parseFloat(entry.km_reading) - parseFloat(vLogs[0].km_reading);
                const fuel = parseFloat(entry.fuel_qty);
                if (dist > 0 && fuel > 0) {
                    const eVal = dist / fuel;
                    eff = eVal.toFixed(1);
                    grade = eVal > 22 ? "S" : (eVal > 18 ? "A" : (eVal > 15 ? "B" : "C"));

                    if (state.logs.length > 1) {
                        const prevDist = state.logs[0].km_reading - state.logs[1].km_reading;
                        const prevEff = prevDist / state.logs[0].fuel_qty;
                        if (prevEff > 0) {
                            const diff = ((eVal - prevEff) / prevEff * 100).toFixed(1);
                            trend = (diff > 0 ? "+" : "") + diff + "%";
                        }
                    }
                }
            }

            document.getElementById("effVal").innerHTML = `${eff} <span class="text-xs">KM/L</span>`;
            document.getElementById("effTrend").textContent = trend;
            document.getElementById("grade").textContent = grade;
            el.style.display = 'flex';
            setTimeout(() => el.style.display = "none", 6000);
        }

        function rend() {
            const container = document.getElementById("logList");
            if (!state.logs.length) {
                container.innerHTML = `<div class="text-center p-8 text-gray-400 font-black uppercase text-xs">No records found</div>`;
                return;
            }

            container.innerHTML = state.logs.slice(0, 50).map((e, i) => {
                const isFull = e.full_tank == true || e.full_tank == "true";
                let effDot = '';

                if (isFull) {
                    const prev = state.logs.slice(i + 1).find(l => l.vehicle_name === e.vehicle_name);
                    if (prev) {
                        const dist = (parseFloat(e.km_reading) || 0) - (parseFloat(prev.km_reading) || 0);
                        const eff = dist / (parseFloat(e.fuel_qty) || 1);
                        if (dist > 0) {
                            const color = eff >= 15 ? 'bg-green-500' : (eff >= 10 ? 'bg-yellow-500' : 'bg-red-500');
                            effDot = `<div class="w-2.5 h-2.5 rounded-full ${color} border border-black/10" title="${eff.toFixed(1)} KM/L"></div>`;
                        }
                    }
                }

                return `
                <div class="log-card p-4 border-b-2 border-[var(--border)] last:border-0 grid grid-cols-[1fr_auto] gap-2 active:bg-black/5 transition-colors">
                    <div>
                        <div class="text-[0.6rem] font-black opacity-50 uppercase tracking-tighter">${e.refill_date.split("T")[0]}</div>
                        <div class="flex items-center gap-2 font-black text-sm uppercase">
                            ${e.vehicle_name} ${effDot}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[0.6rem] font-black border-2 border-[var(--border)] px-1.5 py-0.5 rounded bg-white text-black">${parseFloat(e.fuel_qty).toFixed(2)}L</span>
                            <span class="text-[0.65rem] font-black ${isFull ? 'text-green-600' : 'text-orange-500'} uppercase">${isFull ? 'Full' : 'Partial'}</span>
                        </div>
                        ${e.notes ? `<div class="text-[0.6rem] opacity-60 mt-1 truncate max-w-[180px] font-medium italic">${e.notes}</div>` : ''}
                    </div>
                    <div class="text-right flex flex-col justify-center">
                         <div class="text-xl font-black leading-none">‚Çπ${parseFloat(e.refill_amount).toFixed(0)}</div>
                         <div class="text-[0.6rem] font-black opacity-40 mt-1">‚Çπ${parseFloat(e.fuel_price).toFixed(2)}/L</div>
                    </div>
                </div>`;
            }).join('');
        }

        function stats() {
            const grid = document.getElementById("statsGrid");
            grid.innerHTML = "";
            const datasets = [];

            state.vehicles.forEach((v, idx) => {
                const logs = state.logs.filter(e => e.vehicle_name === v).reverse();
                if (logs.length < 2) return;

                const fuel = logs.reduce((s, e) => s + (parseFloat(e.fuel_qty) || 0), 0);
                const odos = logs.map(e => parseFloat(e.km_reading) || 0);
                const dist = Math.max(...odos) - Math.min(...odos);
                const eff = dist > 0 ? (dist / fuel).toFixed(2) : "0.0";
                const color = state.colors[idx % state.colors.length];

                grid.innerHTML += `
                    <div class="neo-card p-4 flex justify-between items-center">
                        <span class="text-xs font-black uppercase opacity-70">${v}</span>
                        <span class="text-2xl font-black" style="color: ${color}">${eff} <span class="text-xs">KM/L</span></span>
                    </div>`;

                const points = [];
                for (let i = 1; i < logs.length; i++) {
                    const d = logs[i].km_reading - logs[i - 1].km_reading;
                    if (d > 0 && (logs[i].full_tank == true || logs[i].full_tank == "true")) {
                        points.push({
                            x: logs[i].refill_date.split("T")[0].slice(5),
                            y: (d / logs[i].fuel_qty).toFixed(2),
                            _cost: parseFloat(logs[i].refill_amount).toFixed(0)
                        });
                    }
                }
                datasets.push({
                    label: v,
                    data: points,
                    borderColor: color,
                    backgroundColor: color + '11',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 4
                });
            });

            if (state.chart) state.chart.destroy();
            state.chart = new Chart(document.getElementById("effChart"), {
                type: "line",
                data: { datasets },
                options: {
                    responsive: true,
                    scales: {
                        y: { grid: { color: "#00000022" }, ticks: { font: { weight: '800', size: 10, color: "black" } } },
                        x: { type: "category", grid: { display: false }, ticks: { font: { weight: '800', size: 10, color: "black" } } }
                    },
                    plugins: { legend: { labels: { font: { weight: '800', color: "black" } } } }
                }
            });
        }

        async function loadMarket() {
            ui.loading("Updating...");
            navigator.geolocation.getCurrentPosition((p) => {
                google.script.run
                    .withSuccessHandler((res) => {
                        ui.hideLoading();
                        if (!res?.success) return;
                        const m = res.market;
                        document.getElementById("mCity").textContent = `REGION: ${m.city.toUpperCase()}`;
                        document.getElementById("mInsight").textContent = m.insight;
                        document.getElementById("mMarket").innerHTML = `
                            <div class="neo-card p-4 bg-[var(--primary)]/5">
                                <p class="text-[0.6rem] font-black uppercase opacity-60">Petrol</p>
                                <p class="text-2xl font-black">‚Çπ${m.petrol}</p>
                            </div>
                            <div class="neo-card p-4 bg-[var(--primary)]/5">
                                <p class="text-[0.6rem] font-black uppercase opacity-60">Diesel</p>
                                <p class="text-2xl font-black">‚Çπ${m.diesel}</p>
                            </div>`;
                        document.getElementById("mSources").innerHTML = m.sources.map(s =>
                            `<a href="${s.url}" target="_blank" class="block p-3 neo-card text-[0.65rem] font-black uppercase hover:bg-black/5 transition-colors">Source: ${s.title} ‚Üó</a>`
                        ).join("");
                    })
                    .withFailureHandler(err => { ui.hideLoading(); ui.toast("Market Data Unavailable"); })
                    .getMarketData(p.coords.latitude, p.coords.longitude, state.lastPrice);
            }, () => { ui.hideLoading(); ui.toast("Location Denied"); });
        }

        function fetchGPS() {
            navigator.geolocation.getCurrentPosition((p) => {
                document.getElementById("l").value = `${p.coords.latitude.toFixed(3)},${p.coords.longitude.toFixed(3)}`;
            }, () => ui.toast("GPS Signal Lost"), { enableHighAccuracy: true, timeout: 5000 });
        }

        function openScanner(force) {
            const input = document.getElementById('cam');
            force ? input.setAttribute('capture', 'environment') : input.removeAttribute('capture');
            input.click();
        }

        function processImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const max = 800;
                    let w = img.width, h = img.height;
                    if (w > max || h > max) {
                        if (w > h) { h *= max / w; w = max; }
                        else { w *= max / h; h = max; }
                    }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                    ui.loading("Scanning Receipt...");
                    google.script.run
                        .withSuccessHandler((res) => {
                            ui.hideLoading();
                            if (!res?.success) return ui.toast("AI Scan Failed");

                            const mapping = { 'fuel_qty': 'q', 'fuel_price': 'p', 'refill_date': 'd', 'notes': 'n' };
                            Object.entries(mapping).forEach(([key, id]) => {
                                const el = document.getElementById(id);
                                if (res.data[key] && el) {
                                    el.value = res.data[key];
                                    el.classList.add('ring-2', 'ring-yellow-400');
                                    setTimeout(() => el.classList.remove('ring-2', 'ring-yellow-400'), 3000);
                                }
                            });
                            calc();

                            // APPEND GPS TO NOTES (Requested Feature)
                            const notesField = document.getElementById('n');
                            const aiNotes = res.data.notes || "";

                            navigator.geolocation.getCurrentPosition(
                                (pos) => {
                                    const gpsString = `GPS: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                                    // Combine AI notes + GPS
                                    notesField.value = aiNotes ? `${aiNotes} | ${gpsString}` : gpsString;
                                    ui.toast("SCANNED + GPS ADDED");
                                },
                                (err) => {
                                    // Fallback if GPS fails: just show AI notes
                                    console.warn("GPS failed during scan", err);
                                    // Ensure notes are set even if GPS fails
                                    if (aiNotes) notesField.value = aiNotes;
                                    ui.toast("SCANNED (NO GPS)");
                                },
                                { timeout: 4000, enableHighAccuracy: true }
                            );
                        })
                        .withFailureHandler(err => { ui.hideLoading(); ui.toast("AI Error"); })
                        .processReceiptWithAI(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>

</html>

</html>